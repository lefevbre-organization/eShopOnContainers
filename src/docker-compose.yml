version: '3.4'

services:

  seq:
    image: datalust/seq:latest

  sqldata:
    image: mcr.microsoft.com/mssql/server:2017-latest

  nosqldata:
    image: mongo

  rabbitmq:
    image: rabbitmq:3-management-alpine

  webstatus:
    image: ${REGISTRY:-elefebvreoncontainers}/webstatuslef:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Web/WebStatusLef/Dockerfile
 
  identity-api:
    image: ${REGISTRY:-elefebvreoncontainers}/identity.api:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Services/Identity/Identity.API/Dockerfile
    depends_on:
      - sqldata

  webhooks-api:
    image: ${REGISTRY:-elefebvreoncontainers}/webhooks.api:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Services/Webhooks/Webhooks.API/Dockerfile
    depends_on:
      - sqldata

  webportalclient:
    image: ${REGISTRY:-elefebvreoncontainers}/webportalclient:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Web/WebPortalClient/Dockerfile    
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:8.11}
    depends_on:
      - rabbitmq

  webgoogleclient:
    image: ${REGISTRY:-elefebvreoncontainers}/webgoogleclient:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Web/WebGoogleClient/Dockerfile    
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:8.11}
    depends_on:
      - rabbitmq

  webofficeclient:
    image: ${REGISTRY:-elefebvreoncontainers}/webofficeclient:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Web/WebOffice365Client/Dockerfile    
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:8.11}
    depends_on:
      - rabbitmq

  webimapclient:
    image: ${REGISTRY:-elefebvreoncontainers}/webimapclient:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Web/WebImapClient/Dockerfile    
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:8.11}
    depends_on:
      - rabbitmq
      
  weblexonclient:
    image: ${REGISTRY:-elefebvreoncontainers}/weblexonclient:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Web/WebLexonClient/Dockerfile    
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:8.11}
    depends_on:
      - rabbitmq      

  account-api:
    image: ${REGISTRY:-elefebvreoncontainers}/account.api:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Services/Account/Account.API/Dockerfile    
    depends_on:
      - sqldata
      - nosqldata
      - identity-api
      - rabbitmq

  webaccountapigw:
    image: ${REGISTRY:-elefebvreoncontainers}/ocelotapigw:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: ApiGateways/ApiGw-Base/Dockerfile
    depends_on:
      - nosqldata
      - sqldata
      - identity-api
      - rabbitmq
      - account-api

  lexon-api:
    image: ${REGISTRY:-elefebvreoncontainers}/lexon.api:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Services/Lexon/Lexon.API/Dockerfile    
    depends_on:
      - sqldata
      - nosqldata
      - identity-api
      - rabbitmq

  lexonmysql-api:
    image: ${REGISTRY:-elefebvreoncontainers}/lexon.mysql.api:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Services/Lexon/Lexon.MySql/Dockerfile    
    depends_on:
      - sqldata
      - nosqldata
      - identity-api
      - rabbitmq
      - lexon-api

  weblexonapigw:
    image: ${REGISTRY:-elefebvreoncontainers}/ocelotapigw:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: ApiGateways/ApiGw-Base/Dockerfile
    depends_on:
      - nosqldata
      - sqldata
      - identity-api
      - rabbitmq
#     - account-api
      - lexon-api
      - lexonmysql-api
  
  locations-api:
    image: ${REGISTRY:-elefebvreoncontainers}/locations.api:${PLATFORM:-linux}-${TAG:-newcore}
    build:
      context: .
      dockerfile: Services/Location/Locations.API/Dockerfile
    depends_on:
      - nosqldata
      - rabbitmq