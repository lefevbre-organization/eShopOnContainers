<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SmtpService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">api</a> &gt; <a href="index.source.html" class="el_package">com.marcnuri.isotope.api.smtp</a> &gt; <span class="el_source">SmtpService.java</span></div><h1>SmtpService.java</h1><pre class="source lang-java linenums">/*
 * SmtpService.java
 *
 * Created on 2018-10-07, 18:25
 *
 * Copyright 2018 Marc Nuri
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
package com.marcnuri.isotope.api.smtp;

import com.marcnuri.isotope.api.credentials.Credentials;
import com.marcnuri.isotope.api.exception.AuthenticationException;
import com.marcnuri.isotope.api.exception.IsotopeException;
import com.marcnuri.isotope.api.http.IsotopeURLDataSource;
import com.marcnuri.isotope.api.message.Attachment;
import com.marcnuri.isotope.api.message.Message;
import com.marcnuri.isotope.api.message.MessageUtils;
import com.sun.mail.util.MailSSLSocketFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.web.context.annotation.RequestScope;

import javax.activation.DataHandler;
import javax.activation.DataSource;
import javax.annotation.PreDestroy;
import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetHeaders;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;
import javax.mail.internet.MimeUtility;
import javax.mail.util.ByteArrayDataSource;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.nio.charset.Charset;
import java.util.Date;
import java.util.Properties;
import java.util.UUID;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static com.marcnuri.isotope.api.configuration.IsotopeApiConfiguration.DEFAULT_CONNECTION_TIMEOUT;
import static com.marcnuri.isotope.api.exception.AuthenticationException.Type.SMTP;
import static com.marcnuri.isotope.api.folder.FolderResource.REL_DOWNLOAD;
import static com.marcnuri.isotope.api.message.Message.HEADER_IN_REPLY_TO;
import static com.marcnuri.isotope.api.message.Message.HEADER_REFERENCES;

/**
 * Created by Marc Nuri &lt;marc@marcnuri.com&gt; on 2018-10-07.
 */
@Service
@RequestScope
public class SmtpService {

<span class="fc" id="L73">    private static final Logger log = LoggerFactory.getLogger(SmtpService.class);</span>

    private static final String SMTP_PROTOCOL = &quot;smtp&quot;;
    private static final String SMTPS_PROTOCOL = &quot;smtps&quot;;
<span class="fc" id="L77">    private static final Pattern DATA_URI_IMAGE_PATTERN = Pattern.compile(&quot;\&quot;data:(image\\/[^;]*?);base64,([^\\\&quot;]*?)\&quot;&quot;);</span>
    private static final String STYLES =
            &quot;body {font-family: 'Roboto', 'Calibri',  sans-serif; font-size: 1rem; color: #333}&quot; +
            &quot;h1 {margin: 6px 0 16px 0; font-size: 3rem; font-weight: normal}&quot; +
            &quot;h2 {margin: 6px 0 12px 0; font-size: 2.5rem; font-weight: normal}&quot; +
            &quot;h3 {margin: 6px 0 8px 0; font-size: 1.5rem; font-weight: bold}&quot; +
            &quot;blockquote {border-left: 5px solid #ebebeb; font-style: italic; margin: 0; padding: 0 32px}&quot; +
            &quot;pre.code {background-color: #ebebeb; margin: 0; padding: 8px}&quot;;

    private final MailSSLSocketFactory mailSSLSocketFactory;

    private Session session;
    private Transport smtpTransport;

    @Autowired
<span class="fc" id="L92">    public SmtpService(MailSSLSocketFactory mailSSLSocketFactory) {</span>
<span class="fc" id="L93">        this.mailSSLSocketFactory = mailSSLSocketFactory;</span>
<span class="fc" id="L94">    }</span>

    /**
     * Checks if specified {@link Credentials} are valid
     *
     * @param credentials to validate
     * @throws AuthenticationException if credentials are not valid
     */
    public void checkCredentials(Credentials credentials) {
        try {
<span class="fc" id="L104">            getSmtpTransport(credentials);</span>
<span class="fc" id="L105">        } catch (MessagingException e) {</span>
<span class="fc" id="L106">            throw new AuthenticationException(SMTP);</span>
<span class="fc" id="L107">        }</span>
<span class="fc" id="L108">    }</span>

    String sendMessage(HttpServletRequest request, Message message) {
        try {
<span class="fc" id="L112">            final Credentials credentials = getCredentials();</span>
<span class="fc" id="L113">            final Charset currentCharset = Charset.defaultCharset();</span>
<span class="fc" id="L114">            final MimeMessage mimeMessage = new MimeMessage(getSession(credentials));</span>
<span class="fc" id="L115">            mimeMessage.setSentDate(new Date());</span>
<span class="pc bpc" id="L116" title="1 of 4 branches missed.">            if (credentials.getUser() != null &amp;&amp; credentials.getUser().contains(&quot;@&quot;)) {</span>
<span class="fc" id="L117">                mimeMessage.setFrom(credentials.getUser());</span>
            } else {
<span class="fc" id="L119">                mimeMessage.setFrom(String.format(&quot;%s@%s&quot;, credentials.getUser(), credentials.getServerHost()));</span>
            }
<span class="fc bfc" id="L121" title="All 2 branches covered.">            for (javax.mail.Message.RecipientType type : new javax.mail.Message.RecipientType[]{</span>
                    MimeMessage.RecipientType.TO, MimeMessage.RecipientType.CC, MimeMessage.RecipientType.BCC
            }) {
<span class="fc" id="L124">                mimeMessage.setRecipients(type, MessageUtils.getRecipientAddresses(message, type));</span>
            }
<span class="fc" id="L126">            mimeMessage.setSubject(message.getSubject(), currentCharset.name());</span>

<span class="pc bpc" id="L128" title="1 of 2 branches missed.">            if (message.getInReplyTo() != null) {</span>
<span class="nc" id="L129">                mimeMessage.setHeader(HEADER_IN_REPLY_TO, String.join(&quot; &quot;, message.getInReplyTo()));</span>
            }
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">            if (message.getReferences() != null) {</span>
<span class="nc" id="L132">                mimeMessage.setHeader(HEADER_REFERENCES, String.join(&quot; &quot;, message.getReferences()));</span>
            }

<span class="fc" id="L135">            final MimeMultipart multipart = new MimeMultipart();</span>

            // Extract data-uri images to inline attachments
<span class="fc" id="L138">            final String originalContent = message.getContent();</span>
<span class="fc" id="L139">            String finalContent = originalContent;</span>
<span class="fc" id="L140">            final Matcher matcher = DATA_URI_IMAGE_PATTERN.matcher(originalContent);</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">            while(matcher.find()) {</span>
<span class="nc" id="L142">                final String cid = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span>
<span class="nc" id="L143">                final String contentType = matcher.group(1);</span>
<span class="nc" id="L144">                final InternetHeaders headers = new InternetHeaders();</span>
<span class="nc" id="L145">                headers.addHeader(&quot;Content-Type&quot;, contentType);</span>
<span class="nc" id="L146">                headers.addHeader(&quot;Content-Transfer-Encoding&quot;, &quot;base64&quot;);</span>
<span class="nc" id="L147">                final MimeBodyPart cidImagePart = new MimeBodyPart(headers, matcher.group(2).getBytes());</span>
<span class="nc" id="L148">                multipart.addBodyPart(cidImagePart);</span>
<span class="nc" id="L149">                cidImagePart.setDisposition(MimeBodyPart.INLINE);</span>
<span class="nc" id="L150">                cidImagePart.setContentID(String.format(&quot;&lt;%s&gt;&quot;,cid));</span>
<span class="nc" id="L151">                cidImagePart.setFileName(String.format(&quot;%s.%s&quot;, cid, contentType.substring(contentType.indexOf('/') + 1)));</span>
<span class="nc" id="L152">                finalContent = finalContent.replace(matcher.group(), &quot;\&quot;cid:&quot; +cid +&quot;\&quot;&quot;);</span>
<span class="nc" id="L153">            }</span>

            // Include attachments
<span class="pc bpc" id="L156" title="1 of 4 branches missed.">            if (message.getAttachments() != null &amp;&amp; !message.getAttachments().isEmpty()) {</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">                for (Attachment attachment : message.getAttachments()) {</span>
<span class="fc" id="L158">                    multipart.addBodyPart(toBodyPart(request, attachment));</span>
<span class="fc" id="L159">                }</span>
            }

            // Create body part
<span class="fc" id="L163">            final MimeBodyPart body = new MimeBodyPart();</span>
<span class="fc" id="L164">            multipart.addBodyPart(body);</span>
<span class="fc" id="L165">            body.setContent(new String(String.format(&quot;&lt;html&gt;&lt;head&gt;&lt;style&gt;%1$s&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div id='scoped'&gt;&quot;</span>
                            + &quot;&lt;style type='text/css' scoped&gt;%1$s&lt;/style&gt;%2$s&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;,
<span class="fc" id="L167">                            STYLES, finalContent).getBytes(), currentCharset),</span>
<span class="fc" id="L168">                    String.format(&quot;%s; charset=\&quot;%s\&quot;&quot;, MediaType.TEXT_HTML_VALUE, currentCharset.name()));</span>
<span class="fc" id="L169">            mimeMessage.setContent(multipart);</span>

<span class="fc" id="L171">            mimeMessage.saveChanges();</span>
<span class="fc" id="L172">            String[] messageId = mimeMessage.getHeader(&quot;Message-Id&quot;);</span>
<span class="fc" id="L173">            getSmtpTransport(credentials).sendMessage(mimeMessage, mimeMessage.getAllRecipients());</span>
<span class="fc" id="L174">            return messageId[0];</span>
<span class="nc" id="L175">        } catch(MessagingException | IOException ex) {</span>
<span class="nc" id="L176">            throw new IsotopeException(&quot;Problem sending message&quot;, ex);</span>
        }
    }

    @PreDestroy
    public void destroy() {
<span class="fc" id="L182">        log.debug(&quot;SmtpService destroyed&quot;);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if(smtpTransport != null) {</span>
            try {
<span class="nc" id="L185">                smtpTransport.close();</span>
<span class="nc" id="L186">            } catch (MessagingException ex) {</span>
<span class="nc" id="L187">                log.error(&quot;Error closing SMTP Transport&quot;, ex);</span>
<span class="nc" id="L188">            }</span>
        }
<span class="fc" id="L190">    }</span>

    private Session getSession(Credentials credentials) {
<span class="fc bfc" id="L193" title="All 2 branches covered.">        if (session == null) {</span>
<span class="fc" id="L194">            session = Session.getInstance(initMailProperties(credentials, mailSSLSocketFactory), null);</span>
        }
<span class="fc" id="L196">        return session;</span>
    }

    private Transport getSmtpTransport(Credentials credentials) throws MessagingException {
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">        if (smtpTransport == null) {</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">            smtpTransport = getSession(credentials).getTransport(credentials.getSmtpSsl() ? SMTPS_PROTOCOL : SMTP_PROTOCOL);</span>
<span class="fc" id="L202">            final String smtpHost = credentials.getSmtpHost();</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">            smtpTransport.connect(</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                    smtpHost != null &amp;&amp; !smtpHost.isEmpty() ? smtpHost : credentials.getServerHost(),</span>
<span class="fc" id="L205">                    credentials.getSmtpPort(),</span>
<span class="fc" id="L206">                    credentials.getUser(),</span>
<span class="fc" id="L207">                    credentials.getPassword());</span>
<span class="fc" id="L208">            log.debug(&quot;Opened new SMTP transport&quot;);</span>
        }
<span class="fc" id="L210">        return smtpTransport;</span>
    }

    private Credentials getCredentials() {
<span class="fc" id="L214">        return (Credentials)SecurityContextHolder.getContext().getAuthentication();</span>
    }

    private static Properties initMailProperties(Credentials credentials, MailSSLSocketFactory socketFactory) {
<span class="fc" id="L218">        final Properties ret = new Properties();</span>
<span class="fc" id="L219">        ret.put(&quot;mail.smtp.ssl.enable&quot;, credentials.getSmtpSsl());</span>
<span class="fc" id="L220">        ret.put(&quot;mail.smtp.connectiontimeout&quot;, DEFAULT_CONNECTION_TIMEOUT);</span>
<span class="fc" id="L221">        ret.put(&quot;mail.smtp.ssl.socketFactory&quot;, socketFactory);</span>
<span class="fc" id="L222">        ret.put(&quot;mail.smtp.starttls.enable&quot;, true);</span>
<span class="fc" id="L223">        ret.put(&quot;mail.smtp.starttls.required&quot;, false);</span>
<span class="fc" id="L224">        ret.put(&quot;mail.smtps.connectiontimeout&quot;, DEFAULT_CONNECTION_TIMEOUT);</span>
<span class="fc" id="L225">        ret.put(&quot;mail.smtps.socketFactory&quot;, socketFactory);</span>
<span class="fc" id="L226">        ret.put(&quot;mail.smtps.ssl.socketFactory&quot;, socketFactory);</span>
<span class="fc" id="L227">        ret.put(&quot;mail.smtps.socketFactory.fallback&quot;, false);</span>
<span class="fc" id="L228">        ret.put(&quot;mail.smtps.auth&quot;, true);</span>
<span class="fc" id="L229">        return ret;</span>
    }

    private static MimeBodyPart toBodyPart(HttpServletRequest request, Attachment attachment)
            throws MessagingException, IOException {

<span class="fc" id="L235">        final MimeBodyPart mimeAttachment = new MimeBodyPart();</span>
<span class="fc" id="L236">        mimeAttachment.setDisposition(MimeBodyPart.ATTACHMENT);</span>
<span class="pc bpc" id="L237" title="1 of 4 branches missed.">        final String mimeType = attachment.getContentType() != null &amp;&amp; !attachment.getContentType().isEmpty() ?</span>
<span class="fc" id="L238">                attachment.getContentType() : MediaType.APPLICATION_OCTET_STREAM_VALUE;</span>
        final DataSource dataSource;
<span class="fc bfc" id="L240" title="All 2 branches covered.">        if (attachment.getContent() != null) {</span>
<span class="fc" id="L241">            dataSource = new ByteArrayDataSource(attachment.getContent(), mimeType);</span>
        } else {
<span class="fc" id="L243">            dataSource = new IsotopeURLDataSource(attachment.getLink(REL_DOWNLOAD).getTemplate().expand().toURL(),</span>
                    mimeType, request);
        }
<span class="fc" id="L246">        mimeAttachment.setDataHandler(new DataHandler(dataSource));</span>
<span class="fc" id="L247">        mimeAttachment.setFileName(MimeUtility.encodeText(attachment.getFileName()));</span>
<span class="fc" id="L248">        return mimeAttachment;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>